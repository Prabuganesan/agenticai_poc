version: '3.1'

services:
    redis:
        image: redis:alpine
        container_name: autonomous-redis
        ports:
            - '6379:6379'
        volumes:
            - redis_data:/data
        networks:
            - flowise-net

    flowise:
        container_name: flowise-main
        build:
            context: .. # Build using the Dockerfile in the root directory
            dockerfile: docker/Dockerfile
        ports:
            - '${SERVER_PORT:-3030}:${SERVER_PORT:-3030}'
        volumes:
            # Mount local .flowise to container's default location
            - ../.flowise:/root/.flowise
        environment:
            # --- Base Configuration ---
            - AUTONOMOUS_DATA_PATH=${AUTONOMOUS_DATA_PATH}
            - SERVER_PORT=${SERVER_PORT:-3030}
            - SERVER_HOST=${SERVER_HOST}
            - CONTEXT_PATH=${CONTEXT_PATH:-/autonomous}
            - PROXY_URL=${PROXY_URL}
            - DATABASE_PATH=/root/.flowise
            - SECRETKEY_PATH=/root/.flowise
            - LOG_PATH=/root/.flowise/logs
            - BLOB_STORAGE_PATH=/root/.flowise/storage
            # --- Queue Vars (Main Instance) ---
            - MODE=queue
            - QUEUE_NAME=${QUEUE_NAME:-autonomous-queue}
            - REDIS_URL=redis://redis:6379 # Use service name 'redis'
            - REDIS_DB_QUEUE=${REDIS_DB_QUEUE:-3}
            # --- Main Database Configuration ---
            - MAIN_DB_HOST=${MAIN_DB_HOST}
            - MAIN_DB_PORT=${MAIN_DB_PORT}
            - MAIN_DB_DATABASE=${MAIN_DB_DATABASE}
            - MAIN_DB_USER=${MAIN_DB_USER}
            - MAIN_DB_PASSWORD=${MAIN_DB_PASSWORD}
            - MAIN_DB_TYPE=${MAIN_DB_TYPE}
            # --- Redis Configuration ---
            - REDIS_DB_SESSION=${REDIS_DB_SESSION:-1}
            # --- Session Configuration ---
            - SESSION_COOKIE_DOMAIN=${SESSION_COOKIE_DOMAIN}
            # --- License and Encryption ---
            - LICENSE_CODE=${LICENSE_CODE}
            - SIMPLE_CRYPTO_KEY=${SIMPLE_CRYPTO_KEY}
        depends_on:
            - redis
        networks:
            - flowise-net

    flowise-worker:
        container_name: flowise-worker
        build:
            context: .. # Build context is still the root
            dockerfile: docker/worker/Dockerfile # Ensure this path is correct
        volumes:
            # Mount same local .flowise to worker
            - ../.flowise:/root/.flowise
        environment:
            # --- Base Configuration ---
            - AUTONOMOUS_DATA_PATH=${AUTONOMOUS_DATA_PATH}
            - WORKER_PORT=${WORKER_PORT:-5566} # Port for worker healthcheck
            - SERVER_HOST=${SERVER_HOST}
            - CONTEXT_PATH=${CONTEXT_PATH:-/autonomous}
            - PROXY_URL=${PROXY_URL}
            - DATABASE_PATH=/root/.flowise
            - SECRETKEY_PATH=/root/.flowise
            - LOG_PATH=/root/.flowise/logs
            - BLOB_STORAGE_PATH=/root/.flowise/storage
            # --- Queue Vars (Worker Instance) ---
            - MODE=queue
            - QUEUE_NAME=${QUEUE_NAME:-autonomous-queue}
            - REDIS_URL=redis://redis:6379 # Use service name 'redis'
            - REDIS_DB_QUEUE=${REDIS_DB_QUEUE:-3}
            # --- Main Database Configuration ---
            - MAIN_DB_HOST=${MAIN_DB_HOST}
            - MAIN_DB_PORT=${MAIN_DB_PORT}
            - MAIN_DB_DATABASE=${MAIN_DB_DATABASE}
            - MAIN_DB_USER=${MAIN_DB_USER}
            - MAIN_DB_PASSWORD=${MAIN_DB_PASSWORD}
            - MAIN_DB_TYPE=${MAIN_DB_TYPE}
            # --- Redis Configuration ---
            - REDIS_DB_SESSION=${REDIS_DB_SESSION:-1}
            # --- Session Configuration ---
            - SESSION_COOKIE_DOMAIN=${SESSION_COOKIE_DOMAIN}
            # --- License and Encryption ---
            - LICENSE_CODE=${LICENSE_CODE}
            - SIMPLE_CRYPTO_KEY=${SIMPLE_CRYPTO_KEY}
        depends_on:
            - redis
            - flowise
        networks:
            - flowise-net

volumes:
    redis_data:
        driver: local

networks:
    flowise-net:
        driver: bridge
